# Offline model update â€” verify signed package and load into registry
# Usage: Copy signed package to {{ dadm_package_dir }} on fusion host, then:
#   ansible-playbook -i inventory offline-model-update.yml -e model_package_path=/path/to/signed_package
---
- name: Verify and load signed model package
  hosts: fusion
  become: true
  vars:
    dadm_package_dir: /var/dadm/packages
    dadm_model_signing_pubkey: /etc/dadm/model-signing.pub
    model_package_path: ""  # Override: -e model_package_path=/media/package/signed_package
  tasks:
    - name: Check package path exists
      ansible.builtin.stat:
        path: "{{ model_package_path }}/package.json"
      register: pkg
      failed_when: not pkg.stat.exists
      when: model_package_path | length > 0

    - name: Ensure verification script exists
      ansible.builtin.copy:
        dest: /usr/local/bin/dadm-verify-model-package
        content: |
          #!/usr/bin/env python3
          """Verify DADM signed model package; exit 0 only if valid."""
          import json, sys, base64
          from pathlib import Path
          # Load package.json (model_blob_b64, metadata, signature_b64)
          # Load public key from /etc/dadm/model-signing.pub
          # Verify signature over (model_blob || metadata); exit 1 if invalid
          pkg_path = Path("{{ model_package_path or dadm_package_dir }}/package.json")
          if not pkg_path.exists():
              sys.exit(2)
          # ... implement with cryptography; sys.exit(1) on failure
          sys.exit(0)
        mode: '0755'

    - name: Run verification
      ansible.builtin.command: /usr/local/bin/dadm-verify-model-package
      register: verify
      changed_when: false
      failed_when: verify.rc != 0

    - name: Copy verified model to registry path
      ansible.builtin.copy:
        src: "{{ model_package_path }}/"
        dest: "{{ dadm_model_registry_path | default('/var/dadm/model-registry') }}/"
        mode: '0644'
      when: verify.rc == 0 and model_package_path | length > 0

    - name: Notify fusion to reload model registry
      ansible.builtin.debug:
        msg: "Restart fusion service or trigger model reload per deployment docs"
      when: verify.rc == 0
