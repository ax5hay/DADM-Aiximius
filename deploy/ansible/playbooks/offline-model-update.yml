# Offline model update â€” verify signed package and load into registry
# Usage: Copy signed package to {{ dadm_package_dir }} on fusion host, then:
#   ansible-playbook -i inventory offline-model-update.yml -e model_package_path=/path/to/signed_package
---
- name: Verify and load signed model package
  hosts: fusion
  become: true
  vars:
    dadm_package_dir: /var/dadm/packages
    dadm_model_signing_pubkey: /etc/dadm/model-signing.pub
    model_package_path: ""  # Override: -e model_package_path=/media/package/signed_package
  tasks:
    - name: Check package path exists
      ansible.builtin.stat:
        path: "{{ model_package_path }}/package.json"
      register: pkg
      failed_when: not pkg.stat.exists
      when: model_package_path | length > 0

    - name: Ensure verification script exists
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../scripts/verify_model_package.py"
        dest: /usr/local/bin/dadm-verify-model-package
        mode: '0755'

    - name: Ensure cryptography is installed for verification
      ansible.builtin.pip:
        name: cryptography
        state: present
      when: model_package_path | length > 0

    - name: Run verification
      ansible.builtin.command:
        cmd: /usr/local/bin/dadm-verify-model-package "{{ model_package_path or dadm_package_dir }}" "{{ dadm_model_signing_pubkey }}"
      register: verify
      changed_when: false
      failed_when: verify.rc != 0
      when: model_package_path | length > 0

    - name: Copy verified model to registry path
      ansible.builtin.copy:
        src: "{{ model_package_path }}/"
        dest: "{{ dadm_model_registry_path | default('/var/dadm/model-registry') }}/"
        mode: '0644'
      when: model_package_path | length > 0 and (verify.rc | default(1)) == 0

    - name: Notify fusion to reload model registry
      ansible.builtin.debug:
        msg: "Restart fusion service or trigger model reload per deployment docs"
      when: model_package_path | length > 0 and (verify.rc | default(1)) == 0
