# DADM Government Deployment â€” Master playbook
# Run from repo root: ansible-playbook -i inventory deploy/ansible/playbooks/site.yml
---
- name: DADM hardened government deployment
  hosts: all
  become: true
  vars:
    dadm_fips_mode: true
    dadm_audit_log_retention_days: 365
  tasks:
    - name: Ensure FIPS mode (RHEL/CentOS)
      ansible.builtin.lineinfile:
        path: /etc/default/grub
        regexp: '^GRUB_CMDLINE_LINUX='
        line: "GRUB_CMDLINE_LINUX=\"fips=1 {{ ansible_facts['cmdline'] | default('') }}\""
      when:
        - ansible_os_family == 'RedHat'
        - dadm_fips_mode | bool
      notify: reboot for fips

    - name: Verify Secure Boot status (Linux)
      ansible.builtin.command: mokutil --sb-state
      register: secureboot
      changed_when: false
      failed_when: false
      when: ansible_system == 'Linux'

    - name: Record Secure Boot state
      ansible.builtin.set_fact:
        dadm_secure_boot_enabled: "{{ 'Secure Boot is enabled' in secureboot.stdout }}"
      when: ansible_system == 'Linux'

    - name: Install audit log agent (example: ensure rsyslog/auditd config)
      ansible.builtin.include_tasks: tasks/audit_logging.yml
      tags: audit

  handlers:
    - name: reboot for fips
      ansible.builtin.reboot:
        msg: "Reboot required for FIPS mode"
      when: dadm_fips_mode | default(false) | bool

    - name: restart rsyslog
      ansible.builtin.service:
        name: rsyslog
        state: restarted
      when: ansible_os_family in ['RedHat', 'Debian']

- name: Registry and image verification (registry hosts only)
  hosts: registry
  become: true
  tasks:
    - name: Ensure private registry accepts only signed images (documentation)
      ansible.builtin.debug:
        msg: "Configure registry to verify Cosign/Notary signatures; see GOVERNMENT-DEPLOYMENT.md"
      tags: registry

- name: Offline model update (fusion/model-registry hosts)
  hosts: fusion
  become: true
  tasks:
    - name: Ensure model package verify script is present
      ansible.builtin.copy:
        dest: /usr/local/bin/dadm-verify-model-package
        content: |
          #!/bin/bash
          # Verify signed model package; exit 0 only if signature valid
          set -e
          PKG_DIR="{{ dadm_package_dir | default('/var/dadm/packages') }}"
          PUBKEY="{{ dadm_model_signing_pubkey_path | default('/etc/dadm/model-signing.pub') }}"
          for f in "$PKG_DIR"/*.package.json; do
            [ -f "$f" ] || continue
            python3 -c "
          import json, base64, sys
          from pathlib import Path
          # Load package and verify signature (implement with cryptography)
          pkg = json.loads(Path('$f').read_text())
          # ... verification logic; sys.exit(1) if invalid
          "
          done
        mode: '0755'
      tags: model_update
